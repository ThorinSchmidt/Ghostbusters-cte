<div class="charsheet">
	<div>
		<h1 class="header">Ghostbuster-In-Training ID Card</h1>
		<div class="header">
			<p class="header_label">GIT #:</p>
			<input type="text" name="attr_GITnum" size="5">
		</div>
	</div>
	<hr>
	<div>
		<p class="header_label">Name: </p>
		<input type="text" name="attr_name" size = 25">
		<p class="header_label">Goal: </p>
		<input type="text" name="attr_goal" size = 25">
	</div>
	<hr>
	<div class="traits c">
		<h1 class="header">Traits</h1>
		<p class="trait_label"> Brains: </p>
		<input type="number" class="shortnum" name="attr_brains_score" min="1" max="9"	value="0">
		<button type="action" name="act_brains" class="sheet-d6"></button><br>
		
		<p class="trait_label"> Muscles: </p>
		<input type="number" class="shortnum" name="attr_muscles_score" min="1" max="9" value="0">
		<button type="action" name="act_muscles" class="sheet-d6"></button><br>
		
		<p class="trait_label"> Moves: </p>
		<input type="number" class="shortnum" name="attr_moves_score" min="1" max="9"	value="0">
		<button type="action" name="act_moves" class="sheet-d6"></button><br>
		
		<p class="trait_label"> Cool: </p>
		<input type="number" class="shortnum" name="attr_cool_score" min="1" max="9"	value="0">
		<button type="action" name="act_cool" class="sheet-d6"></button><br>

		<p class="trait_label"> Power: </p>
		<input type="number" class="shortnum" name="attr_power_score" min="0" max="9"	value="0">
	</div>
	
	<div class="talents c">
		<h1 class="header">Talents</h1>
		<input type="text" name="attr_brains_tal_name" size="15" class="talent_name">
		<input type="number" class="shortnum" name="attr_brains_tal_score"	min="4" max="12" value="0">
		<button type="action" name="act_brains_tal" class="sheet-d6"></button><br>

		<input type="text" name="attr_muscles_tal_name" size="15" class="talent_name">
		<input type="number" class="shortnum" name="attr_muscles_tal_score" min="4" max="12"	value="0">
		<button type="action" name="act_muscles_tal" class="sheet-d6"></button><br>

		<input type="text" name="attr_moves_tal_name"	size="15" class="talent_name">
		<input type="number" class="shortnum" name="attr_moves_tal_score" min="4" max="12"	value="0">
		<button type="action" name="act_moves_tal" class="sheet-d6"></button><br>

		<input type="text" name="attr_cool_tal_name"	size="15" class="talent_name">
		<input type="number" class="shortnum" name="attr_cool_tal_score"	min="4" max="12"	value="0">
		<button type="action" name="act_cool_tal" class="sheet-d6"></button><br>

		<input type="text" name="attr_power_tal_name"	size="15" class="talent_name">
		<button type="action" name="act_power_tal" class="sheet-d6"></button><br>
	
	</div>
	<div class="bp c">
		<h1 class="header">Brownie Points</h1>
		<p class="bp_label">BP Max:</p>
		<input type="number" class="shortnum" name="attr_bp_max" min="0" max="60"
			value="20"><br>
		
		<p class="bp_label">BP Spent:</p>
		<input type="number" class="shortnum" name="attr_bp_spent" min="0" max="60"
			value="0"><br>
		
		<p class="bp_label">BP Current:</p>
		<input type="number" class="shortnum" name="attr_bp_current" min="0" max="60"
			value="20"><br>

		<br>
		
		<p class="bp_label">Add BP to Roll: </p>
		<input type="number" class="shortnum" name="attr_bp_add" min="0" max="60"
			value="0"><br>
	</div>
	<hr style="clear:both;">
	<div class=notes c">
		<h1 class="header">Notes</h1>
		<textarea name="attr_notes"></textarea>
	</div>
	<div class="extras c">
		<h1 class="header">Extras</h1>
		<p class="extras_label"> Roll 1 Ghost Die: </p>
		<button type="action" name="act_oneghost" class="sheet-ghostdie"></button><br>

		<p class="extras_label"> Roll 1 D6: </p>
		<button type="action" name="act_onedsix" class="sheet-d6"></button><br>
	</div>
	<hr style="clear:both;">
  <h1 class="header">Academic Progress Record</h1>
  <div class="isp">
    <table class="c">
      <caption><h3>Individualized Study Program</h3></caption>
      <thead>
        <tr>
          <th>Old Talent</th>
          <th>New Talent</th>
          <th>Progress</th>
          <th>Target</th>
        </tr>
      </thead>
      <tr>
        <td><input type="text" name="attr_old_tal_1" size="15" 
          class="talent_name"></td>
        <td><input type="text" name="attr_new_tal_1" size="15" 
          class="talent_name"></td>
        <td><input type="number" class="shortnum" name="attr_progress_1"	min="0" value="0"></td>
        <td><input type="number" class="shortnum" name="attr_target_1"	  min="30" max="30"
          value="30"></td>
      </tr>
      <tr>
        <td><input type="text" name="attr_old_tal_2" size="15" 
          class="talent_name"></td>
        <td><input type="text" name="attr_new_tal_2" size="15" 
          class="talent_name"></td>
        <td><input type="number" class="shortnum" name="attr_progress_2"	min="0" value="0"></td>
        <td><input type="number" class="shortnum" name="attr_target_2"	  min="30" max="30"
          value="30"></td>
      </tr>
      <tr>
        <td><input type="text" name="attr_old_tal_3" size="15" 
          class="talent_name"></td>
        <td><input type="text" name="attr_new_tal_3" size="15" 
          class="talent_name"></td>
        <td><input type="number" class="shortnum" name="attr_progress_3"	min="0" value="0"></td>
        <td><input type="number" class="shortnum" name="attr_target_3"	  min="30" max="30"
          value="30"></td>
      </tr>
      <tr>
        <td><input type="text" name="attr_old_tal_4" size="15" 
          class="talent_name"></td>
        <td><input type="text" name="attr_new_tal_4" size="15" 
          class="talent_name"></td>
        <td><input type="number" class="shortnum" name="attr_progress_4"	min="0" value="0"></td>
        <td><input type="number" class="shortnum" name="attr_target_4"	  min="0" max="30"
          value="30"></td>
      </tr>
    </table>
    <table class="c">
      <caption><h3>Personal Development</h3></caption>
      <thead>
        <tr>
          <th>Chosen Traio</th>
          <th>Progress</th>
          <th>Target</th>
        </tr>
      </thead>
      <tr>
        <td><input type="text" name="attr_chosen_trait" size="15" 
          class="trait_name"></td>
        <td><input type="number" class="shortnum" name="attr_progress_trait"
          min="0" value="0"></td>
        <td><input type="number" class="shortnum" name="attr_target_trait"
          min="30" max="60" step="30" value="30"></td>
      </tr>
    </table>
  </div>
  <div class="financial">
    <table class="c">
      <caption><h3>Financial Standing</h3></caption>
      <tr>
        <td>Credits:</td><td>$</td>
        <td><input type="text" class="longnum" name="attr_credits"
          size="10" value="0"></td>
        <td>.00</td>
      </tr>
      <tr>
        <td> - Debits: </td><td>$</td>
        <td><input type="text" class="longnum" name="attr_debits"
          size="10" value="0"></td>
        <td>.00</td>
      </tr>
      <tr><td colspan="3"><hr></td></tr>
      <tr>
        <td> = Net:    </td><td>$</td>
        <td><input type="text" class="longnum" name="attr_net"
          size="10" value="0"></td>
        <td>.00</td>
      </tr>
      <tr><td colspan="3"><hr class="dbl_hr"></td></tr>
      <tr>
        <td>Student Obligation: </td><td>$</td>
        <td><input type="text" class="longnum" name="attr_amt_owed"
          size="10" value="0"></td>
        <td>.00</td>
      </tr>
      <tr>
        <td>Student Award:      </td><td>$</td>
        <td><input type="text" class="longnum" name="attr_amt_award"
          size="10" value="0"></td>
        <td>.00</td>
      </tr>
    </table>  
  </div>
  <div>
    
  </div>
	<hr style="clear:both;">
</div>

<rolltemplate class="sheet-rolltemplate-gbcte">
	<div class="spacer"></div>
	<div class="heading">
		<h4>{{name}}</h4>
		<p>{{description}}</p>
	</div>
	<div class="regular">
		<h3>Regular d6s: {{roll1}}</h3>
	</div>
	<div class="ghost">
		<h3>Ghost Die: {{computed::roll1}}</h3>
	</div>
	<div class="total">
		<h2>Total: {{computed::roll2}}</h2>
	</div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-d6">
	<div class="spacer"></div>
	<div class="heading">
		<h3>{{name}}</h3>
	</div>
	<div class="ghost">
		<h1>{{computed::roll1}}</h1>
	</div>
</rolltemplate>

<script type="text/worker">

  on("change:credits change:debits", function() {
    console.log("Financial Change Detected!!");
    getAttrs(["credits", "debits"], function(values) {
      let credit_int = parseInt(values.credits)||0;
      let debit_int = parseInt(values.debits)||0;
      let net_int = credit_int - debit_int;
      let award_int = 0;
      let owed_int = 0;
      
      if (net_int < 0) {
        award_int = 0;
        owed_int = Math.round(Math.abs(net_int) * .7);
      } else {
        owed_int = 0;
        award_int = Math.round(net_int * .7);
      }
      
      setAttrs({                            
				"net": net_int,
				"amt_owed": owed_int,
				"amt_award": award_int,
			});
    });
  });

	on("change:brains_score change:muscles_score " +
		 "change:moves_score change:cool_score " +
		 "change:bp_max change:bp_spent sheet:opened", function() {
		console.log("change detected!");
		getAttrs(["brains_score", "muscles_score", "moves_score",
							"cool_score", "bp_max", "bp_spent"], function(values) {
			let br_tal = 3 + parseInt(values.brains_score)||0;
			let mu_tal = 3 + parseInt(values.muscles_score)||0;
			let mo_tal = 3 + parseInt(values.moves_score)||0;
			let cl_tal = 3 + parseInt(values.cool_score)||0;
			let max = parseInt(values.bp_max)||0;
			let spent = parseInt(values.bp_spent)||0;
			let current = max - spent;
			
			setAttrs({                            
				"brains_tal_score": br_tal,
				"muscles_tal_score": mu_tal,
				"moves_tal_score": mo_tal,
				"cool_tal_score": cl_tal,
				"bp_current": current,
			});
		});
	});

	on('clicked:brains', (info) => {
		console.log("Brains");
		getAttrs(["brains_score", "bp_add", "bp_spent"], function(values) {
			let name = "Brains";
			let number = parseInt(values.brains_score)||0;
			let added = parseInt(values.bp_add)||0;
			let spent = parseInt(values.bp_spent)||0;
			console.log("parsing:", name, number, added, spent);
			parseRoll(name, number, added, spent);
		});
	});

	on('clicked:muscles', (info) => {
		console.log("Muscles");
		getAttrs(["muscles_score", "bp_add", "bp_spent"], function(values) {
			let name = "Muscles";
			let number = parseInt(values.muscles_score)||0;
			let added = parseInt(values.bp_add)||0;
			let spent = parseInt(values.bp_spent)||0;
			console.log("parsing:", name, number, added, spent);
			parseRoll(name, number, added, spent);
		});
	});

	on('clicked:moves', (info) => {
		console.log("moves");
		getAttrs(["moves_score", "bp_add", "bp_spent"], function(values) {
			let name = "Moves";
			let number = parseInt(values.moves_score)||0;
			let added = parseInt(values.bp_add)||0;
			let spent = parseInt(values.bp_spent)||0;
			console.log("parsing:", name, number, added, spent);
			parseRoll(name, number, added, spent);
		});
	});

	on('clicked:cool', (info) => {
		console.log("cool");
		getAttrs(["cool_score", "bp_add", "bp_spent"], function(values) {
			let name = "Cool";
			let number = parseInt(values.cool_score)||0;
			let added = parseInt(values.bp_add)||0;
			let spent = parseInt(values.bp_spent)||0;
			console.log("parsing:", name, number, added, spent);
			parseRoll(name, number, added, spent);
		});
	});

	on('clicked:brains_tal', (info) => {
		console.log("Brains_tal");
		getAttrs(["brains_tal_name", "brains_tal_score", "bp_add", "bp_spent"], function(values) {
			let name = values.brains_tal_name||"blank";
			let number = parseInt(values.brains_tal_score)||0;
			let added = parseInt(values.bp_add)||0;
			let spent = parseInt(values.bp_spent)||0;
			console.log("parsing:", name, number, added, spent);
			parseRoll(name, number, added, spent);
		});
	});

	on('clicked:muscles_tal', (info) => {
		console.log("muscles_tal");
		getAttrs(["muscles_tal_name", "muscles_tal_score", "bp_add", "bp_spent"], function(values) {
			let name = values.muscles_tal_name||"blank";
			let number = parseInt(values.muscles_tal_score)||0;
			let added = parseInt(values.bp_add)||0;
			let spent = parseInt(values.bp_spent)||0;
			console.log("parsing:", name, number, added, spent);
			parseRoll(name, number, added, spent);
		});
	});

	on('clicked:moves_tal', (info) => {
		console.log("moves_tal");
		getAttrs(["moves_tal_name", "moves_tal_score", "bp_add", "bp_spent"], function(values) {
			let name = values.moves_tal_name||"blank";
			let number = parseInt(values.moves_tal_score)||0;
			let added = parseInt(values.bp_add)||0;
			let spent = parseInt(values.bp_spent)||0;
			console.log("parsing:", name, number, added, spent);
			parseRoll(name, number, added, spent);
		});
	});

	on('clicked:cool_tal', (info) => {
		console.log("cool_tal");
		getAttrs(["cool_tal_name", "cool_tal_score", "bp_add", "bp_spent"], function(values) {
			let name = values.cool_tal_name||"blank";
			let number = parseInt(values.cool_tal_score)||0;
			let added = parseInt(values.bp_add)||0;
			let spent = parseInt(values.bp_spent)||0;
			console.log("parsing:", name, number, added, spent);
			parseRoll(name, number, added, spent);
		});
	});

	on('clicked:power_tal', (info) => {
		console.log("power_tal");
		getAttrs(["power_tal_name", "power_score",
							"bp_add", "bp_spent"], function(values) {
			let name = values.power_tal_name||"blank";
			let number = parseInt(values.power_score)||0;
			let added = parseInt(values.bp_add)||0;
			let spent = parseInt(values.bp_spent)||0;
			console.log("parsing:", name, number, added, spent);
			if (number > 0) {
			    parseRoll(name, number, added, spent);
			}
		});
	});

	on('clicked:oneghost clicked:onedsix', (info) => {
		let name = "Ghost Die";
		let die_roll = 0;
		let die_result = "0";
		
		if (info.triggerName == "clicked:onedsix") {
			name = "1D6";
		}

		startRoll(`&{template:d6} {{name=${name}:}} {{roll1=[[1d6]]}}`, (results) => {
			
			die_roll = results.results.roll1.result;
			die_result = die_roll.toString();
			
			if (info.triggerName == "clicked:oneghost" &&
					die_roll == 6) {
				die_result = "GHOST!";
			}
			
			finishRoll(results.rollId,
				{
					roll1: die_result
				}
			);
		});
	});
	
	function parseRoll(name, number, added, spent) {
		let reg_dice = number + added - 1; // add BPs to roll and -1 for Ghost Die
		let new_spent = spent + added;  
		let ghost_roll = "#";
		
		//reset the "bp_add" and "bp_spent" fields. "bp_current" will update automatically. 
		setAttrs({
			"bp_add": 0,
			"bp_spent": new_spent,
		});
			
		startRoll(`&{template:gbcte} {{name=${name}:}} ` +
							`{{description=Rolling ${reg_dice}d6 + Ghost Die...}}`+
							` {{roll1=[[${reg_dice}d6]]}} {{roll2=[[1d6]]}}`,
							(results) => {
			let regular = results.results.roll1.result;
			let ghost = results.results.roll2.result;
			let total = regular;
			
			if (ghost < 6) {
				total += ghost;
				ghost_roll = ghost.toString();
			} else {
				ghost_roll = "GHOST!";
			}
						
			finishRoll(results.rollId,
				{
					roll1: ghost_roll,
					roll2: total
				}
			);
		});
	}

</script>
